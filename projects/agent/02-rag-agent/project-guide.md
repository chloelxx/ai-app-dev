# 02 RAG Agent 项目说明（模板）

## 一、项目概述

- **项目名称**：02 RAG Agent - 检索增强型智能问答 Agent
- **项目级别**：初级 / 进阶过渡
- **项目目标**：在 01 Basic Agent 的基础上，引入 RAG（Retrieval-Augmented Generation）能力，熟悉：
  - 文档解析、分块与嵌入
  - 向量数据库的构建与查询
  - 检索结果与大模型生成的协同（RAG Pipeline）
  - 将 RAG 能力整合进 Agent 流程
- **预期产出**：
  - 一个基于自建知识库的问答 Agent 服务
  - 一套可复用的 RAG 组件（索引构建脚本、检索接口等）

## 二、项目背景与场景

> 本节用于描述一个**知识密集型**的应用场景，示例：
>
> - 公司内部知识库问答（技术文档、产品说明书、流程手册）
> - 课程 / 书籍的知识问答助手
> - FAQ 文档自动问答
>
> 在实际填写时，请明确：
> - 使用的文档类型（PDF、Markdown、HTML、纯文本等）
> - 文档大致规模（多少篇 / 字数级别）
> - 用户最关心的典型问题有哪些？

建议结构：

- **业务场景**：  
  描述知识库的来源与主要内容（例如“公司内部产品手册”）。
- **核心痛点**：  
  手动查文档效率低、信息分散、难以记忆。
- **RAG Agent 价值**：  
  通过“问题 → 检索文档片段 → 基于上下文回答”的方式，提供高相关、高可解释的答案。

## 三、功能需求设计

### 3.1 必备功能

- **知识库构建**
  - 支持将原始文档导入系统（可从本地目录读取）
  - 对文档进行解析与分块（分段策略需可配置或清晰记录）
  - 使用预训练 Embedding 模型生成向量
  - 将向量与元数据写入向量数据库

- **向量检索**
  - 根据用户问题生成查询向量
  - 从向量数据库中检索 Top-K 相关文档片段
  - 返回文档片段内容 + 基本元数据（标题、来源文件、页码或章节等）

- **RAG 问答流程**
  - 问题 → 向量检索 → 选取若干片段作为上下文 → 调用大模型生成答案
  - 支持配置：
    - Top-K 数量
    - 每个片段的最大长度
    - 总上下文长度限制策略（截断 / 摘要）

- **Agent 集成**
  - 在 01 Basic Agent 的基础对话框架中，增加“RAG 模式”：
    - 用户问题需要查知识库时，Agent 会触发 RAG 流程
    - 回答中可以引用相关文档片段（如附上“参考来源”）

- **基础观测与日志**
  - 记录每次检索的 Top-K 命中情况（可打印到日志）
  - 可选：记录用户反馈（如“这个回答是否有用？Y/N”）

### 3.2 可选增强功能

- **查询重写**：对用户问题进行重写 / 扩展，以提升检索效果
- **基于得分的片段重排序**：对检索结果进行二次排序或过滤
- **多路召回**：结合关键字检索（BM25）与向量检索
- **RAG 模式切换**：支持“仅模型生成 / 仅检索结果 / 检索+生成”多种模式

## 四、技术栈与架构

### 4.1 推荐技术栈

- **后端语言**：Python 3.10+
- **Web 框架**：FastAPI（沿用 01 项目）
- **向量数据库**（任选其一或可替换）：
  - Chroma（轻量、本地优先）
  - Milvus / Zilliz Cloud
  - Pinecone / Weaviate 等
- **Embedding 模型**：
  - OpenAI Embeddings
  - Hugging Face Sentence Transformers
  - 国内可用 Embedding 服务（根据实际环境选择）

### 4.2 模块划分建议

- `ingestion`：数据导入与预处理（解析、清洗、分块）
- `embeddings`：嵌入模型封装
- `vector_store`：向量数据库读写封装
- `retriever`：检索器（对外暴露统一的“检索 API”）
- `rag_pipeline`：RAG 主流程（检索 + 上下文构造 + 调用 LLM）
- `agent`：将 RAG 能力集成到对话 Agent 中

示例目录结构（在 `02-rag-agent/` 中）：

- `src/`
  - `main.py`
  - `ingestion/…`
  - `embeddings/…`
  - `vector_store/…`
  - `retriever/…`
  - `rag_pipeline/…`
  - `agent/…`
- `scripts/`
  - `build_index.py`（构建向量索引）
  - `update_index.py`（可选，增量更新）
- `tests/`
- `README.md`

## 五、详细实现步骤（里程碑）

> 建议同样拆解为若干小里程碑，便于对照执行。

### 里程碑 1：数据准备与分块策略

- 选定一批用于实验的文档（可以是公司内网文档的脱敏版本或公开文档）
- 实现文档读取与解析（PDF / Markdown / TXT 至少一种）
- 设计并实现分块策略：
  - 按段落 / 按固定字数 / 按标题层级等
  - 明确记录当前策略的优缺点与可调参数

### 里程碑 2：Embedding 与向量库构建

- 封装 `EmbeddingClient`：
  - 接收文本列表，返回向量列表
  - 处理批量请求与异常情况
- 选择并集成一个向量数据库：
  - 定义向量记录结构：`id`、`embedding`、`text`、`metadata`
- 实现索引构建脚本 `scripts/build_index.py`：
  - 从原始文档目录读取文本
  - 分块 → 嵌入 → 写入向量库

### 里程碑 3：检索接口与评估

- 实现 `Retriever`：
  - 输入：用户问题文本
  - 流程：生成查询向量 → 从向量库中检索 Top-K 片段
  - 输出：片段列表及其相似度得分
- 编写若干典型问题，用于手工检查检索效果：
  - 记录：哪些问题检索效果好，哪些不理想
  - 思考可能的改进（如分块粒度、Embedding 模型、Top-K 值等）

### 里程碑 4：RAG Pipeline + LLM 集成

- 构建 `RAGPipeline`：
  - 输入：用户问题
  - 步骤：
    1. 调用 `Retriever` 获取相关片段
    2. 将片段格式化为上下文（带来源信息）
    3. 构建 Prompt：问题 + 上下文 + 约束（如“必须基于文档回答”）
    4. 调用大模型生成最终答案
  - 输出：答案 + 可选“参考文档列表”
- 提供一个测试接口（可在 FastAPI 中添加 `/rag/qa`）：
  - 方便通过 HTTP 调用验证 RAG 流程

### 里程碑 5：整合到 Agent 与体验优化

- 在现有 Basic Agent 中增加“RAG 模式”：
  - 当用户问题与知识库相关时，优先触发 RAG Pipeline
  - Agent 在回答中可以说明“依据某文档/章节”
- 增加简单的反馈机制（可选）：
  - 用户可以反馈“回答是否有用”
  - 将反馈记录下来，为后续调优提供依据

## 六、测试与验收标准

### 6.1 功能测试

- **索引构建**
  - 确认索引构建脚本可以在无报错的情况下完成
  - 向量库中实际有记录（可通过简单查询或统计）
- **检索效果**
  - 为知识库准备一批测试问题
  - 检查返回的 Top-K 片段是否与问题高度相关
- **RAG 回答**
  - 对比“纯 LLM 回答”和“RAG + LLM 回答”的差异
  - 检查是否出现“胡编乱造”（hallucination）减少的情况

### 6.2 验收标准（示例）

- 必须项：
  - 提供可运行的 RAG Agent 服务（含启动说明）
  - 提供构建索引的脚本与说明
  - 至少 10 个覆盖不同类型问题的测试示例（问题 + 期望包含的信息）
- 加分项：
  - 对检索质量进行简单量化评估（如 Top-K 命中率）
  - 支持增量更新知识库
  - 支持多数据源（如多种文件格式或多目录）

## 七、文档要求

项目应至少包含以下文档：

- `README.md`
  - 项目简介、功能说明
  - 环境依赖、安装与运行步骤
  - 构建索引与更新索引的操作说明
  - 示例请求与典型问题列表
- `ARCHITECTURE.md`（推荐）
  - 模块划分说明（ingestion / embeddings / vector_store / retriever / rag_pipeline / agent）
  - RAG Pipeline 流程图或文字说明
- `NOTES.md`（可选）
  - 不同实验配置（分块长度、Top-K、Embedding 模型）的结果对比
  - 对检索效果与回答质量的主观评估
  - 后续计划与优化想法

## 八、复盘与扩展方向

项目完成后，建议至少回答如下问题：

- 当前分块策略的优缺点是什么？在什么情况下容易出错？
- 是否存在“检索到的片段相关，但回答仍然不理想”的情况？原因可能是什么？
- 如果要支持多轮对话中的 RAG（上下文相关问题），你会如何改造当前架构？
- 如何将当前 RAG Agent 与后续的多 Agent 工作流（03 项目）结合？
- 若要在企业生产环境中使用，还需要增加哪些能力（权限控制、审计、监控等）？

> 提示：请将上述复盘内容写入 `NOTES.md`，为后续 `03-multi-agent-workflow` 与 `04-enterprise-agent-service` 的设计提供输入。


